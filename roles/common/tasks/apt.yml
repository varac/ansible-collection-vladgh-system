---
- name: Disable APT repositories
  ansible.builtin.apt_repository:
    repo: "{{ item.repo }}"
    codename: "{{ ansible_distribution_release | default(omit) }}"
    filename: "{{ item.filename | default(omit) }}"
    update_cache: "{{ item.update_cache | default(true) }}"
    state: "{{ item.state | default('absent') }}"
  loop: "{{ apt_disable_repositories }}"
  when: apt_disable_repositories is defined and apt_disable_repositories

- name: Add extra APT repositories
  when: >
    ( apt_extra_keys is defined and apt_extra_keys ) or
    ( apt_extra_repositories is defined and apt_extra_repositories )
  block:
    - name: Ensure GnuPG package is installed
      ansible.builtin.apt:
        name: gnupg2
        update_cache: yes

    - name: Add an Apt signing key to a specific keyring file
      ansible.builtin.get_url:
        url: "{{ item.url }}"
        dest: "/etc/apt/trusted.gpg.d/{{ item.filename | default(item.name) }}.asc"
        mode: "{{ item.mode | default('0644') }}"
      loop: "{{ apt_extra_keys }}"
      when: item.url is defined and item.url

    - name: Add extra APT repositories
      ansible.builtin.apt_repository:
        repo: "{{ item.repo }}"
        codename: "{{ ansible_distribution_release | default(omit) }}"
        filename: "{{ item.filename | default(omit) }}"
        update_cache: "{{ item.update_cache | default(true) }}"
        state: "{{ item.state | default('present') }}"
      loop: "{{ apt_extra_repositories }}"
      when: apt_extra_repositories is defined and apt_extra_repositories
